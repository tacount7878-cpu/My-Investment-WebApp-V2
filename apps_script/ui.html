<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>äº¤æ˜“ç´€éŒ„ V6.41</title>

<!-- å¼•å…¥ Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- å¼•å…¥ Chart.js DataLabels æ“´å…… (ç”¨ä¾†é¡¯ç¤º % æ•¸) -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

<style>
:root{
  --bg0:#070b12; --bg1:#0b1220;
  --card:#0f1a2c; --txt:#e8eefc;
  --muted:#a9b6d6; --line:rgba(255,255,255,.08);
  --blue:#2f7bff; --blue2:#1a57c8;
  --red:#ff3b30; --green:#34c759; --shadow: 0 18px 60px rgba(0,0,0,.45);
  --radius:18px;
}
*{box-sizing:border-box;}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",Arial;
  background:linear-gradient(180deg,var(--bg0),var(--bg1));
  color:var(--txt);
  padding:20px;
  min-height: 100vh;
}
.card{
  max-width:520px;
  margin:auto;
  background:rgba(255,255,255,.05);
  border:1px solid var(--line);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:20px;
}
.title{font-size:22px;font-weight:900;margin-bottom:10px;}
.hint{color:var(--muted);font-size:14px;margin:6px 0;}
.bigInput{
  width:100%;height:60px;font-size:20px;font-weight:800;
  background:rgba(0,0,0,.25);color:white;
  border:1px solid var(--line);
  border-radius:14px;padding:0 14px;
}
.bigInput:focus{
  border-color:var(--blue);
  box-shadow:0 0 0 4px rgba(47,123,255,.2);
}

/* éš±è—æ•¸å­—è¼¸å…¥æ¡†çš„ä¸Šä¸‹ç®­é ­ */
input[type="number"]::-webkit-outer-spin-button,
input[type="number"]::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}
input[type="number"] {
  -moz-appearance: textfield;
}

.chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;}
.chip{
  padding:8px 12px;border-radius:999px;
  background:rgba(47,123,255,.15);
  border:1px solid rgba(47,123,255,.35);
  font-size:13px;font-weight:800;
  cursor:pointer;
}
button.primary{
  width:100%;height:60px;
  margin-top:16px;
  border-radius:16px;
  background:linear-gradient(180deg,var(--blue),var(--blue2));
  border:none;color:white;
  font-size:18px;font-weight:900;
  cursor:pointer;
}
.toast{ margin-top:12px;font-weight:800; text-align:center; }

/* è¦–åœ–åˆ‡æ›èˆ‡æŒ‰éˆ•æ¨£å¼ */
.view { display: none; animation: fadeIn 0.3s ease; }
.view.active { display: block; }
@keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

.btn-group { display:flex; gap:10px; margin-bottom:16px; max-width:520px; margin-left:auto; margin-right:auto; }
button.secondary{
  flex:1; height:50px;
  border-radius:14px;
  background:rgba(255,255,255,0.1);
  border:1px solid var(--line); color:white;
  font-size:15px; font-weight:800;
  display:flex; align-items:center; justify-content:center; gap:6px;
  cursor:pointer; transition:0.2s;
}
button.secondary:active{ background:rgba(255,255,255,0.2); transform:scale(0.98); }
button.action-btn { background:rgba(47,123,255,0.2); border-color:rgba(47,123,255,0.5); color:#8bb4ff;}

/* åœ–è¡¨èˆ‡è¨ˆç®—æ©Ÿå°ˆå±¬æ¨£å¼ */
.chart-card { background:rgba(0,0,0,0.2); border-radius:14px; padding:15px; margin-bottom:16px; border:1px solid var(--line);}
.chart-title { font-size:16px; font-weight:800; margin-bottom:12px; text-align:center; color:var(--txt);}
.chart-container{ position:relative; height:240px; width:100%; }

.calc-row { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; padding-bottom:12px; border-bottom:1px solid var(--line); }
.calc-label { font-size:15px; color:var(--muted); font-weight:700;}
.calc-value { font-size:18px; font-weight:900; color:white; }
.calc-input { width:140px; height:40px; font-size:18px; font-weight:800; text-align:right; background:rgba(0,0,0,0.4); border:1px solid var(--line); border-radius:8px; color:white; padding:0 10px;}
.calc-input:focus { border-color:var(--blue); outline:none; }

.final-networth {
  background: linear-gradient(135deg, rgba(52,199,89,0.15), rgba(52,199,89,0.05));
  border: 1px solid rgba(52,199,89,0.4);
  border-radius: 16px; padding: 20px; text-align: center; margin-top: 20px;
}
.final-label { color: #a3e4b5; font-size: 14px; font-weight: 800; margin-bottom: 8px; }
.final-val { color: #34c759; font-size: 36px; font-weight: 900; font-variant-numeric: tabular-nums; }

#loading-overlay-dash, #loading-overlay-net { font-size:14px; color:var(--muted); text-align:center; padding:40px 0; }
#env-tag { position: fixed; top: 10px; right: 10px; font-size: 10px; color: var(--muted); opacity: 0.5; z-index:999;}
.update-indicator { font-size:12px; color:var(--green); text-align:center; margin-bottom:15px; font-weight:700; opacity:0; transition:opacity 0.3s;}
</style>
</head>

<body>

<div id="env-tag">V6.41 Preview</div>

<!-- ================= è¦–åœ– 1ï¼šè¼¸å…¥è¡¨å–® ================= -->
<div id="view-input" class="view active">
  <div class="btn-group">
    <button class="secondary" onclick="switchView('dashboard')">ğŸ“Š æˆ°æƒ…åœ–è¡¨</button>
    <button class="secondary" onclick="switchView('networth')">ğŸ’° å³æ™‚ç¸½è³‡ç”¢</button>
  </div>

  <div class="card">
    <div class="title">äº¤æ˜“ç´€éŒ„</div>

    <div class="hint">äº¤æ˜“é¡å‹</div>
    <select id="type" class="bigInput">
      <option value="è²·å…¥">è²·å…¥</option>
      <option value="è³£å‡º">è³£å‡º</option>
    </select>

    <div class="hint">æ¨™çš„åç¨±ï¼ˆå¿…å¡«ï¼‰</div>
    <input id="name" class="bigInput" placeholder="ä¾‹å¦‚ï¼šå¯Œé‚¦å°50">

    <div class="hint">è‚¡ç¥¨ä»£è™Ÿ</div>
    <input id="symbol" class="bigInput" placeholder="ä¾‹å¦‚ï¼š006208.TW">

    <div class="hint">å¸¸ç”¨å¿«é¸</div>
    <div class="chips">
      <div class="chip" onclick="quick('å¯Œé‚¦å°50','006208.TW')">å¯Œé‚¦å°50</div>
      <div class="chip" onclick="quick('å°ç©é›»','2330.TW')">å°ç©é›»</div>
      <div class="chip" onclick="quick('Alphabet','GOOGL')">Alphabet</div>
      <div class="chip" onclick="quick('Tesla','TSLA')">Tesla</div>
      <div class="chip" onclick="quick('Bitcoin','BTC-USD')">æ¯”ç‰¹å¹£</div>
    </div>

    <div class="hint">åƒ¹æ ¼</div>
    <input id="price" class="bigInput" type="number" step="any" inputmode="decimal">

    <div class="hint">è‚¡æ•¸</div>
    <input id="qty" class="bigInput" type="number" step="any" inputmode="decimal">

    <button class="primary" onclick="submitTrade()">é€å‡ºäº¤æ˜“</button>
    <div id="msg" class="toast"></div>
  </div>
</div>

<!-- ================= è¦–åœ– 2ï¼šåœ–è¡¨å„€è¡¨æ¿ ================= -->
<div id="view-dashboard" class="view">
  <div class="btn-group">
    <button class="secondary" onclick="switchView('input')">ğŸ”™ æ–°å¢äº¤æ˜“</button>
    <button class="secondary action-btn" onclick="refreshDashboard(false)">ğŸ”„ æ‰‹å‹•æ›´æ–°</button>
  </div>

  <div class="card">
    <div class="title">æˆ°æƒ…å„€è¡¨æ¿</div>
    <div id="update-msg-dash" class="update-indicator">âœ¨ æ•¸æ“šå·²æ›´æ–°</div>
    
    <div id="loading-overlay-dash">æ•¸æ“šè¼‰å…¥ä¸­...</div>
    
    <div id="dashboard-content" style="display:none;">
      <div class="chart-card">
        <div class="chart-title">è³‡ç”¢ç¸½æ·¨å€¼ (TWD)</div>
        <div class="chart-container"><canvas id="historyChart"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-title">æŒå€‰ä½”æ¯” (åˆä½µå¾Œ)</div>
        <div class="chart-container"><canvas id="assetsChart"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-title">æŠ•è³‡åœ°å€åˆ†ä½ˆ</div>
        <div class="chart-container"><canvas id="regionsChart"></canvas></div>
      </div>
    </div>
  </div>
</div>

<!-- ================= è¦–åœ– 3ï¼šå³æ™‚ç¸½è³‡ç”¢ ================= -->
<div id="view-networth" class="view">
  <div class="btn-group">
    <button class="secondary" onclick="switchView('input')">ğŸ”™ æ–°å¢äº¤æ˜“</button>
    <button class="secondary action-btn" onclick="refreshDashboard(false)">ğŸ”„ æ‰‹å‹•æ›´æ–°</button>
  </div>

  <div class="card">
    <div class="title">ğŸ’° å³æ™‚ç¸½è³‡ç”¢</div>
    <div id="update-msg-net" class="update-indicator">âœ¨ æ•¸æ“šå·²æ›´æ–°</div>
    
    <div id="loading-overlay-net">æ•¸æ“šè¼‰å…¥ä¸­...</div>

    <div id="networth-content" style="display:none;">
      
      <div class="chart-card" style="border-color:rgba(47,123,255,0.3);">
        <div class="calc-row">
          <div class="calc-label">ğŸ“Š æŠ•è³‡éƒ¨ä½ç¸½å¸‚å€¼ (TWD)</div>
          <div class="calc-value" id="val-invest">0</div>
        </div>
        <div class="calc-row">
          <div class="calc-label">ğŸ“ˆ å ±é…¬ç‡ (å·²å¯¦ç¾)</div>
          <div class="calc-value" id="val-return" style="color:var(--green);">0.00%</div>
        </div>
        <div class="calc-row">
          <div class="calc-label">ğŸ’µ å·²å¯¦ç¾ç¸½æç›Š (TWD)</div>
          <div class="calc-value" id="val-realized-twd" style="color:var(--green);">0</div>
        </div>
        <div class="calc-row" style="border:none; margin-bottom:0; padding-bottom:0;">
          <div class="calc-label">ğŸ’± å³æ™‚åŒ¯ç‡ (USD/TWD)</div>
          <div class="calc-value" id="val-usdrate" style="color:var(--muted);">31.41</div>
        </div>
      </div>

      <div class="hint" style="margin-top:20px; margin-bottom:10px;">è¼¸å…¥ç›®å‰å¸³æˆ¶é¤˜é¡</div>
      
      <div class="calc-row">
        <div class="calc-label">å¸³æˆ¶ç¾é‡‘ (TWD)</div>
        <input type="number" id="inp-cash-twd" class="calc-input" placeholder="0" inputmode="decimal" step="any" oninput="calcTotalNetWorth()">
      </div>
      <div class="calc-row">
        <div class="calc-label">äº¤å‰²ä¸­ç¾é‡‘ (TWD)</div>
        <input type="number" id="inp-settle-twd" class="calc-input" placeholder="0" inputmode="decimal" step="any" oninput="calcTotalNetWorth()">
      </div>
      <div class="calc-row">
        <div class="calc-label">ç¾å…ƒç¾é‡‘ (USD)</div>
        <input type="number" id="inp-cash-usd" class="calc-input" placeholder="0" inputmode="decimal" step="any" oninput="calcTotalNetWorth()">
      </div>
      <div class="calc-row" style="border-color:rgba(255,59,48,0.3);">
        <div class="calc-label" style="color:#ff6b6b;">è²¸æ¬¾é‡‘é¡ (TWD)</div>
        <input type="number" id="inp-loan-twd" class="calc-input" placeholder="0" inputmode="decimal" step="any" oninput="calcTotalNetWorth()" style="color:#ff6b6b;">
      </div>

      <div class="final-networth">
        <div class="final-label">è³‡ç”¢ç¸½æ·¨å€¼ (æ‰£é™¤è²¸æ¬¾)</div>
        <div class="final-val" id="val-final-networth">0</div>
      </div>
    </div>
  </div>
</div>

<script>
Chart.register(ChartDataLabels);

const isGasEnv = typeof google !== 'undefined' && google.script && google.script.run;
document.getElementById('env-tag').innerText = isGasEnv ? "Mode: Online" : "Mode: Preview Simulator";

// æ¨¡æ“¬å™¨é‚è¼¯
const scriptRun = isGasEnv ? google.script.run : (() => {
  const mockObj = {
    _callback: null,
    withSuccessHandler: function(cb) { this._callback = cb; return this; },
    withFailureHandler: function(cb) { return this; },
    getDashboardData: function(inputs, isManual) {
      setTimeout(() => {
        if (this._callback) this._callback({
          history: [
            {date:'01/07', val:5358703}, {date:'01/08', val:5333739}, {date:'01/09', val:5357119}, 
            {date:'01/14', val:5360433}, {date:'01/16', val:5583811}, {date:'01/22', val:5323136}, 
            {date:'01/24', val:5311442}, {date:'01/26', val:5318288}, {date:'01/27', val:5390603}, 
            {date:'01/29', val:5334134}, {date:'01/30', val:5283226}, {date:'02/02', val:5293960}, 
            {date:'02/03', val:5352465}, {date:'02/04', val:5308897}, {date:'02/05', val:5245594}, 
            {date:'02/09', val:5406319}, {date:'02/14', val:5698248}
          ],
          assets: [
            {name:'0050', value:2316000}, 
            {name:'2330', value:381085},
            {name:'å‚µå·(å°è‚¡)', value:1054130},
            {name:'VT/VWRA', value:2310949},
            {name:'TSLA (ç‰¹æ–¯æ‹‰)', value:379346},
            {name:'Google (Alphabet)', value:392013},
            {name:'IBKR', value:8869},
            {name:'Bitcoin', value:232460}
          ],
          regions: [
            {name:'å°è‚¡', value:2697085}, {name:'ç¾è‚¡', value:780228}, 
            {name:'å…¨çƒ', value:2310949}, {name:'åŠ å¯†', value:232460},
            {name:'å‚µå·(å°è‚¡)', value:1054130}
          ],
          investTotal: 7074856, 
          usdRate: 31.41, 
          realizedReturn: 22.41,
          realizedReturnTwd: 250034
        });
      }, 400);
    },
    saveTrades: function(payload) {
      setTimeout(() => {
        if (this._callback) this._callback({ ok: true, row: 99 });
      }, 500);
    }
  };
  return mockObj;
})();

let historyChart, assetsChart, regionsChart;
let isDataLoaded = false; 
let cachedData = null; 
let currentInvestTotal = 0;
let currentUsdRate = 31.41;

window.onload = () => {
  ['cash-twd','cash-usd','loan-twd','settle-twd'].forEach(id => {
    const el = document.getElementById('inp-'+id);
    if (el) {
      const val = localStorage.getItem('wr_'+id.replace('-','_'));
      if(val) el.value = val;
    }
  });
  
  if(document.getElementById('inp-cash-usd') && !document.getElementById('inp-cash-usd').value) document.getElementById('inp-cash-usd').value = "4170.99";
  if(document.getElementById('inp-loan-twd') && !document.getElementById('inp-loan-twd').value) document.getElementById('inp-loan-twd').value = "1507627";
  
  calcTotalNetWorth();
  refreshDashboard(true);
};

function switchView(viewName) {
  document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
  document.getElementById('view-' + viewName).classList.add('active');
  if(viewName !== 'input') renderCharts();
}

function refreshDashboard(isSilent = false) {
  if(!isSilent) {
    const dashOverlay = document.getElementById('loading-overlay-dash');
    const netOverlay = document.getElementById('loading-overlay-net');
    const dashContent = document.getElementById('dashboard-content');
    const netContent = document.getElementById('networth-content');
    if(dashOverlay) dashOverlay.style.display = 'block';
    if(netOverlay) netOverlay.style.display = 'block';
    if(dashContent) dashContent.style.display = 'none';
    if(netContent) netContent.style.display = 'none';
  }

  const inputs = {
    cashTwd: document.getElementById('inp-cash-twd').value,
    settleTwd: document.getElementById('inp-settle-twd').value,
    cashUsd: document.getElementById('inp-cash-usd').value,
    loanTwd: document.getElementById('inp-loan-twd').value
  };
  
  scriptRun.withSuccessHandler(data => {
    cachedData = data;
    isDataLoaded = true;
    
    const dashOverlay = document.getElementById('loading-overlay-dash');
    const netOverlay = document.getElementById('loading-overlay-net');
    const dashContent = document.getElementById('dashboard-content');
    const netContent = document.getElementById('networth-content');
    if(dashOverlay) dashOverlay.style.display = 'none';
    if(netOverlay) netOverlay.style.display = 'none';
    if(dashContent) dashContent.style.display = 'block';
    if(netContent) netContent.style.display = 'block';

    currentInvestTotal = data.investTotal; currentUsdRate = data.usdRate;
    document.getElementById('val-invest').innerText = data.investTotal.toLocaleString();
    document.getElementById('val-usdrate').innerText = data.usdRate.toFixed(2);
    
    const ret = data.realizedReturn || 0;
    const retEl = document.getElementById('val-return');
    retEl.innerText = (ret > 0 ? '+' : '') + ret.toFixed(2) + '%';
    retEl.style.color = ret >= 0 ? 'var(--green)' : 'var(--red)';
    
    const retTwd = data.realizedReturnTwd || 0;
    const retTwdEl = document.getElementById('val-realized-twd');
    retTwdEl.innerText = (retTwd > 0 ? '+' : '') + retTwd.toLocaleString();
    retTwdEl.style.color = retTwd >= 0 ? 'var(--green)' : 'var(--red)';
    
    calcTotalNetWorth();
    if(!isSilent) showUpdateIndicator();
    renderCharts();
  }).getDashboardData(inputs, !isSilent);
}

function calcTotalNetWorth() {
  const cashTwdEl = document.getElementById('inp-cash-twd');
  const settleTwdEl = document.getElementById('inp-settle-twd');
  const cashUsdEl = document.getElementById('inp-cash-usd');
  const loanTwdEl = document.getElementById('inp-loan-twd');

  const t = Number(cashTwdEl ? cashTwdEl.value : 0) || 0;
  const s = Number(settleTwdEl ? settleTwdEl.value : 0) || 0;
  const u = Number(cashUsdEl ? cashUsdEl.value : 0) || 0;
  const l = Number(loanTwdEl ? loanTwdEl.value : 0) || 0;
  
  localStorage.setItem('wr_cash_twd', t); 
  localStorage.setItem('wr_settle_twd', s); 
  localStorage.setItem('wr_cash_usd', u); 
  localStorage.setItem('wr_loan_twd', l);
  
  const total = currentInvestTotal + t + s + (u * currentUsdRate) - l;
  const finalEl = document.getElementById('val-final-networth');
  if (finalEl) finalEl.innerText = Math.round(total).toLocaleString();
}

function renderCharts() {
  if(!cachedData) return;
  
  // 1. History Chart - éš±è—æ¯å€‹æ•¸æ“šé»ä¸Šçš„é‡‘é¡æ¨™ç±¤
  const ctxH = document.getElementById('historyChart').getContext('2d');
  if(historyChart) historyChart.destroy();
  historyChart = new Chart(ctxH, { 
    type: 'line', 
    data: { 
      labels: cachedData.history.map(d=>d.date), 
      datasets:[{ label:'ç¸½æ·¨å€¼', data:cachedData.history.map(d=>d.val), borderColor:'#2f7bff', fill:true, backgroundColor:'rgba(47,123,255,0.1)', tension:0.4 }] 
    }, 
    options: { 
      responsive:true, maintainAspectRatio:false, 
      plugins:{
        legend:{display:false},
        datalabels:{ display: false } // éš±è—æŠ˜ç·šåœ–æ¨™ç±¤
      }, 
      scales:{ x:{ticks:{color:'#a9b6d6'}}, y:{ticks:{color:'#a9b6d6'}} } 
    } 
  });
  
  // 2. Assets Chart - ç§»é™¤é‚Šæ¡† (borderWidth: 0)
  const ctxA = document.getElementById('assetsChart').getContext('2d');
  if(assetsChart) assetsChart.destroy();
  assetsChart = new Chart(ctxA, { 
    type: 'doughnut', 
    data: { 
      labels: cachedData.assets.map(d=>d.name), 
      datasets:[{ 
        data:cachedData.assets.map(d=>d.value), 
        backgroundColor:['#4285F4','#34A853','#FBBC05','#EA4335','#00BCD4','#8E24AA','#FF9800','#9E9E9E'],
        borderWidth: 0 // ç§»é™¤é‚Šæ¡†
      }] 
    }, 
    options: { 
      responsive:true, maintainAspectRatio:false, 
      plugins:{ 
        legend:{position:'right',labels:{color:'#fff',boxWidth:12}},
        datalabels:{ 
          color:'#fff', font:{weight:'bold',size:10},
          formatter:(v,c)=>{
            let sum=0; c.dataset.data.forEach(x=>sum+=x);
            if((v*100/sum) < 4) return null;
            return (v*100/sum).toFixed(1)+'%';
          }
        } 
      } 
    } 
  });

  // 3. Regions Chart - ç§»é™¤é‚Šæ¡† (borderWidth: 0)
  const ctxR = document.getElementById('regionsChart').getContext('2d');
  if(regionsChart) regionsChart.destroy();
  regionsChart = new Chart(ctxR, { 
    type: 'doughnut', 
    data: { 
      labels: cachedData.regions.map(d=>d.name), 
      datasets:[{ 
        data:cachedData.regions.map(d=>d.value), 
        backgroundColor:['#2f7bff','#34c759','#5856d6','#ff9500','#ff3b30'],
        borderWidth: 0 // ç§»é™¤é‚Šæ¡†
      }] 
    }, 
    options: { 
      responsive:true, maintainAspectRatio:false, cutout: '55%',
      plugins:{ 
        legend:{position:'right',labels:{color:'#fff',boxWidth:12}},
        datalabels:{ 
          color:'#fff', font:{weight:'bold',size:10},
          formatter:(v,c)=>{
            let sum=0; c.dataset.data.forEach(x=>sum+=x);
            return (v*100/sum).toFixed(1)+'%';
          }
        } 
      } 
    } 
  });
}

function showUpdateIndicator() {
  ['dash','net'].forEach(id => { 
    const el = document.getElementById('update-msg-'+id);
    if(el) {
      el.style.opacity = 1; 
      setTimeout(() => el.style.opacity = 0, 2000); 
    }
  });
}

function quick(n,s){ document.getElementById('name').value=n; document.getElementById('symbol').value=s; }
function submitTrade(){
  showMsg("â³ äº¤æ˜“å¯«å…¥ä¸­...");
  scriptRun.withSuccessHandler(res => {
    showMsg("âœ… æˆåŠŸå¯«å…¥");
    document.getElementById("name").value = "";
    document.getElementById("symbol").value = "";
    document.getElementById("price").value = "";
    document.getElementById("qty").value = "";
  }).saveTrades({});
}
function showMsg(m){ document.getElementById("msg").innerText = m; }
</script>
</body>
</html>