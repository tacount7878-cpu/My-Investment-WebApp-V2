<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>交易紀錄 V6.61 - 預覽模式</title>

<!-- 引入 Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- 引入 Chart.js DataLabels 擴充 -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

<style>
:root{
  --bg0:#070b12; --bg1:#0b1220;
  --card:#0f1a2c; --txt:#e8eefc;
  --muted:#a9b6d6; --line:rgba(255,255,255,.08);
  --blue:#2f7bff; --blue2:#1a57c8;
  --red:#ff3b30; --green:#34c759; --shadow: 0 18px 60px rgba(0,0,0,.45);
  --radius:18px;
  --purple: #6e45e2; --purple2: #88d3ce;
}
*{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",Arial;
  background:linear-gradient(180deg,var(--bg0),var(--bg1));
  color:var(--txt);
  padding:20px;
  min-height: 100vh;
  overflow-x: hidden;
}
.card{
  max-width:520px;
  margin:auto;
  background:rgba(255,255,255,.05);
  border:1px solid var(--line);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:20px;
  margin-bottom: 80px;
}
.title{font-size:22px;font-weight:900;margin-bottom:10px;}
.hint{color:var(--muted);font-size:14px;margin:12px 0 6px 0;}
.bigInput{
  width:100%;height:60px;font-size:20px;font-weight:800;
  background:rgba(0,0,0,.25);color:white;
  border:1px solid var(--line);
  border-radius:14px;padding:0 14px;
}
.bigInput:focus{ border-color:var(--blue); outline:none; box-shadow:0 0 0 4px rgba(47,123,255,.2); }

input[type="number"]::-webkit-outer-spin-button,
input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
input[type="number"] { -moz-appearance: textfield; }

.chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;}
.chip{ padding:8px 12px;border-radius:999px; background:rgba(47,123,255,.15); border:1px solid rgba(47,123,255,.35); font-size:13px;font-weight:800; cursor:pointer; }

button.primary{ width:100%;height:60px; margin-top:24px; border-radius:16px; background:linear-gradient(180deg,var(--blue),var(--blue2)); border:none;color:white; font-size:18px;font-weight:900; cursor:pointer; }
.toast{ margin-top:12px;font-weight:800; text-align:center; padding: 10px; border-radius: 8px; display: none; }
.toast.info { display: block; background: rgba(47,123,255,0.2); color: #8bb4ff; }

.view { display: none; animation: fadeIn 0.3s ease; }
.view.active { display: block; }
@keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

.btn-group { display:flex; gap:10px; margin-bottom:16px; max-width:520px; margin-left:auto; margin-right:auto; }
button.secondary{ flex:1; height:50px; border-radius:14px; background:rgba(255,255,255,0.1); border:1px solid var(--line); color:white; font-size:15px; font-weight:800; cursor:pointer; transition:0.2s; }
button.action-btn { background:rgba(47,123,255,0.2); border-color:rgba(47,123,255,0.5); color:#8bb4ff;}

/* 🤖 AI 視窗樣式 */
#ai-fab {
  position: fixed; bottom: 30px; right: 20px;
  width: 68px; height: 68px; border-radius: 50%;
  background: linear-gradient(135deg, var(--purple), var(--purple2));
  box-shadow: 0 10px 30px rgba(110, 69, 226, 0.6);
  display: flex; align-items: center; justify-content: center;
  font-size: 32px; cursor: pointer; z-index: 9999;
}

#ai-window {
  position: fixed; top: 15%; left: 5%;
  width: 90%; max-width: 400px; height: 500px;
  background: rgba(22, 27, 34, 0.9);
  backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
  border-radius: 28px; border: 1px solid rgba(110, 69, 226, 0.4);
  box-shadow: 0 30px 80px rgba(0,0,0,0.7);
  z-index: 10000; display: none; flex-direction: column;
  overflow: hidden;
  touch-action: none; 
}
#ai-header { padding: 16px 20px; background: rgba(110, 69, 226, 0.25); display: flex; justify-content: space-between; align-items: center; cursor: move; border-bottom: 1px solid rgba(255,255,255,0.1); }
#ai-chat-body { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 14px; scroll-behavior: smooth; }
.msg { max-width: 85%; padding: 12px 16px; border-radius: 20px; font-size: 15px; line-height: 1.6; }
.msg-mimi { align-self: flex-start; background: rgba(255,255,255,0.1); color: #e8eefc; border-bottom-left-radius: 4px; }
.msg-user { align-self: flex-end; background: var(--purple); color: white; border-bottom-right-radius: 4px; }
#ai-footer { padding: 15px; display: flex; gap: 10px; border-top: 1px solid rgba(255,255,255,0.1); }
#ai-input { flex: 1; background: rgba(255,255,255,0.08); border: 1px solid var(--line); border-radius: 14px; color: white; padding: 12px; outline: none; }
#ai-send { width: 48px; height: 48px; background: var(--purple); border: none; border-radius: 12px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px;}

/* 圖表樣式 */
.chart-card { background:rgba(0,0,0,0.2); border-radius:14px; padding:15px; margin-bottom:16px; border:1px solid var(--line);}
.chart-title { font-size:16px; font-weight:800; margin-bottom:12px; text-align:center; color:var(--txt);}
.chart-container{ position:relative; height:240px; width:100%; }

.calc-row { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; padding-bottom:12px; border-bottom:1px solid var(--line); }
.calc-value { font-size:18px; font-weight:900; color:white; }
.calc-input { width:140px; height:40px; font-size:18px; font-weight:800; text-align:right; background:rgba(0,0,0,0.4); border:1px solid var(--line); border-radius:8px; color:white; padding:0 10px;}

.final-networth { background: linear-gradient(135deg, rgba(52,199,89,0.15), rgba(52,199,89,0.05)); border: 1px solid rgba(52,199,89,0.4); border-radius: 16px; padding: 20px; text-align: center; margin-top: 20px; }
.final-val { color: #34c759; font-size: 36px; font-weight: 900; }

#loading-overlay-dash, #loading-overlay-net { font-size:14px; color:var(--muted); text-align:center; padding:40px 0; }
.preview-badge { position:fixed; top:10px; left:10px; background:rgba(255,149,0,.2); color:#ff9500; padding:4px 8px; border-radius:6px; font-size:10px; font-weight:bold; border:1px solid rgba(255,149,0,.3); z-index:10001; pointer-events:none; }
</style>
</head>

<body>

<div class="preview-badge">PREVIEW MODE</div>

<!-- 🤖 浮動按鈕 -->
<div id="ai-fab" onclick="toggleAI()">🤖</div>

<!-- 🤖 視窗 -->
<div id="ai-window">
  <div id="ai-header">
    <div class="ai-title">🤖 咪咪戰情分析</div>
    <button style="background:none; border:none; color:white; font-size:24px; cursor:pointer;" onclick="toggleAI()">×</button>
  </div>
  <div id="ai-chat-body">
    <div class="msg msg-mimi">嗨，翔翔。😊</div>
  </div>
  <div id="ai-footer">
    <input type="text" id="ai-input" placeholder="問問大姊姊..." onkeypress="if(event.keyCode==13) sendChat()">
    <button id="ai-send" onclick="sendChat()">➤</button>
  </div>
</div>

<!-- ================= 視圖 1：輸入表單 ================= -->
<div id="view-input" class="view active">
  <div class="btn-group">
    <button class="secondary" onclick="switchView('dashboard')">📊 戰情圖表</button>
    <button class="secondary" onclick="switchView('networth')">💰 即時總資產</button>
  </div>

  <div class="card">
    <div class="title">交易紀錄</div>
    
    <div class="hint">交易類型</div>
    <select id="type" class="bigInput">
      <option value="買入">買入</option>
      <option value="賣出">賣出</option>
    </select>

    <div class="hint">標的名稱</div>
    <input id="name" class="bigInput" placeholder="例如：富邦台50">

    <div class="hint">股票代號</div>
    <input id="symbol" class="bigInput" placeholder="例如：006208.TW">

    <div class="hint">常用快選</div>
    <div class="chips">
      <div class="chip" onclick="quick('富邦台50','006208.TW','元大(台股)')">富邦台50</div>
      <div class="chip" onclick="quick('台積電','2330.TW','元大(台股)')">台積電</div>
      <div class="chip" onclick="quick('VWRA','VWRA.L','IBKR')">VWRA</div>
      <div class="chip" onclick="quick('TSLA(FT)','TSLA','Firstrade(FT)')">TSLA(FT)</div>
      <div class="chip" onclick="quick('比特幣','BTC-USD','錢包')">比特幣</div>
    </div>

    <div class="hint">價格</div>
    <input id="price" class="bigInput" type="number" step="any" inputmode="decimal">

    <div class="hint">股數</div>
    <input id="qty" class="bigInput" type="number" step="any" inputmode="decimal">

    <div class="hint">手續費</div>
    <input id="fee" class="bigInput" type="number" step="any" placeholder="未填自動 0" inputmode="decimal">

    <div class="hint">交易稅</div>
    <input id="tax" class="bigInput" type="number" step="any" placeholder="未填自動 0" inputmode="decimal">

    <div class="hint">成本（賣出必填）</div>
    <input id="cost" class="bigInput" type="number" step="any" inputmode="decimal">

    <div class="hint">平台</div>
    <select id="platform" class="bigInput">
      <option value="元大(台股)">元大(台股)</option>
      <option value="元大複委託(美股)">元大複委託(美股)</option>
      <option value="Firstrade(FT)">Firstrade(FT)</option>
      <option value="IBKR">IBKR</option>
      <option value="錢包">錢包</option>
    </select>

    <div class="hint">帳戶類型</div>
    <select id="account" class="bigInput">
      <option value="TWD帳戶">TWD帳戶</option>
      <option value="USD外幣帳戶">USD外幣帳戶</option>
      <option value="其他">其他</option>
    </select>

    <button class="primary" onclick="submitTrade()">送出交易</button>
    <div id="msg" class="toast"></div>
  </div>
</div>

<!-- ================= 視圖 2：戰情圖表 ================= -->
<div id="view-dashboard" class="view">
  <div class="btn-group">
    <button class="secondary" onclick="switchView('input')">🔙 返回</button>
    <button class="secondary action-btn" onclick="refreshDashboard(false)">🔄 手動更新</button>
  </div>
  <div class="card">
    <div class="title">戰情儀表板</div>
    <div id="loading-overlay-dash">載入中...</div>
    <div id="dashboard-content" style="display:none;">
      <div class="chart-card"><div class="chart-title">資產總淨值 (TWD)</div><div class="chart-container"><canvas id="historyChart"></canvas></div></div>
      <div class="chart-card"><div class="chart-title">持倉佔比 (合併後)</div><div class="chart-container"><canvas id="assetsChart"></canvas></div></div>
      <div class="chart-card"><div class="chart-title">投資地區分佈</div><div class="chart-container"><canvas id="regionsChart"></canvas></div></div>
    </div>
  </div>
</div>

<!-- ================= 視圖 3：即時總資產 ================= -->
<div id="view-networth" class="view">
  <div class="btn-group">
    <button class="secondary" onclick="switchView('input')">🔙 返回</button>
    <button class="secondary action-btn" onclick="refreshDashboard(false)">🔄 手動更新</button>
  </div>
  <div class="card">
    <div class="title">💰 即時總資產</div>
    <div id="networth-content">
      <div class="chart-card">
        <div class="calc-row"><span>📊 投資部位市值</span><span id="val-invest">0</span></div>
        <div class="calc-row"><span>📈 報酬率 (已實現)</span><span id="val-return" style="color:var(--green)">+22.4%</span></div>
        <div class="calc-row"><span>💱 即時匯率 (USD)</span><span id="val-usdrate">32.2</span></div>
      </div>
      <div class="hint" style="margin-top:20px;">輸入目前的帳戶餘額</div>
      <div class="calc-row"><span>台幣現金</span><input type="number" id="inp-cash-twd" class="calc-input" oninput="calcTotalNetWorth()"></div>
      <div class="calc-row"><span>交割現金</span><input type="number" id="inp-settle-twd" class="calc-input" oninput="calcTotalNetWorth()"></div>
      <div class="calc-row"><span>美金現金</span><input type="number" id="inp-cash-usd" class="calc-input" oninput="calcTotalNetWorth()"></div>
      <div class="calc-row" style="color:#ff6b6b;"><span>貸款金額</span><input type="number" id="inp-loan-twd" class="calc-input" oninput="calcTotalNetWorth()" style="color:#ff6b6b;"></div>
      <div class="final-networth"><div class="final-val" id="val-final-networth">0</div></div>
    </div>
  </div>
</div>

<script>
Chart.register(ChartDataLabels);

// 模擬器邏輯
const scriptRun = (() => {
  return {
    withSuccessHandler: function(cb) { this._cb = cb; return this; },
    getDashboardData: function(i) {
      setTimeout(() => this._cb({
        history: [
            {date:'01/07', val:5350000}, {date:'01/16', val:5580000}, {date:'01/24', val:5320000}, 
            {date:'01/30', val:5360000}, {date:'02/05', val:5230000}, {date:'02/14', val:5710000}, {date:'02/17', val:5685000}
        ],
        assets: [
            {name:'0050', value:2316000}, {name:'2330', value:381085}, {name:'債券(台股)', value:1054130},
            {name:'VT/VWRA', value:2310949}, {name:'TSLA', value:379346}, {name:'Google', value:392013}, {name:'Bitcoin', value:232460}
        ],
        regions: [{name:'台股', value:3751215}, {name:'美股', value:801083}, {name:'全球', value:2310949}, {name:'加密', value:232460}],
        investTotal: 7065983, usdRate: 32.2, realizedReturn: 22.4, realizedReturnTwd: 250000
      }), 400);
    },
    saveTrades: function(p) { setTimeout(() => { showToast("✅ 模擬寫入成功！"); this._cb({ok:true, row: 99}); }, 500); },
    callGeminiAnalysis: function(q) {
      setTimeout(() => this._cb("翔翔乖，大姊姊算好囉。目前的配置中「台股」佔比最高，建議可以多留意美股夜盤的變動喔。晚點姊姊再陪你對帳。😊"), 1000);
    }
  };
})();

let charts = {};
let cachedData = null;

window.onload = () => {
  ['cash-twd','settle-twd','cash-usd','loan-twd'].forEach(id => {
    const val = localStorage.getItem('wr_'+id.replace('-','_'));
    if(val) document.getElementById('inp-'+id).value = val;
  });
  refreshDashboard(true);
  initDraggable();
};

function switchView(v) {
  document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
  document.getElementById('view-' + v).classList.add('active');
  if(v !== 'input') {
      setTimeout(() => renderCharts(), 100);
  }
}

function refreshDashboard(isSilent) {
  scriptRun.withSuccessHandler(data => {
    cachedData = data;
    document.getElementById('loading-overlay-dash').style.display = 'none';
    document.getElementById('dashboard-content').style.display = 'block';
    document.getElementById('val-invest').innerText = data.investTotal.toLocaleString();
    document.getElementById('val-usdrate').innerText = data.usdRate.toFixed(2);
    calcTotalNetWorth();
    renderCharts();
  }).getDashboardData({});
}

function calcTotalNetWorth() {
  const t = Number(document.getElementById('inp-cash-twd').value || 0);
  const s = Number(document.getElementById('inp-settle-twd').value || 0);
  const u = Number(document.getElementById('inp-cash-usd').value || 0);
  const l = Number(document.getElementById('inp-loan-twd').value || 0);
  localStorage.setItem('wr_cash_twd', t); localStorage.setItem('wr_settle_twd', s); 
  localStorage.setItem('wr_cash_usd', u); localStorage.setItem('wr_loan_twd', l);
  const rate = cachedData ? cachedData.usdRate : 32.2;
  const total = (cachedData ? cachedData.investTotal : 0) + t + s + (u * rate) - l;
  document.getElementById('val-final-networth').innerText = Math.round(total).toLocaleString();
}

function renderCharts() {
  if(!cachedData) return;
  const config = (id, type, labels, data, isPie) => {
    const canvas = document.getElementById(id);
    if(!canvas) return;
    const ctx = canvas.getContext('2d');
    if(charts[id]) charts[id].destroy();
    charts[id] = new Chart(ctx, {
      type: type,
      data: { labels, datasets: [{ data, backgroundColor: isPie ? ['#4285F4','#34A853','#FBBC05','#EA4335','#00BCD4','#8E24AA','#FF9800','#9E9E9E'] : 'rgba(47,123,255,0.2)', borderColor: '#2f7bff', fill: true, tension: 0.4, borderWidth: isPie ? 0 : 2 }] },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: isPie, position: 'right', labels:{color:'#fff', boxWidth:10} }, datalabels: { display: isPie, color: '#fff', font: { weight: 'bold', size: 10 }, formatter: (v, c) => { let sum = 0; c.dataset.data.forEach(x => sum += x); let perc = (v * 100 / sum).toFixed(1); return perc > 3 ? perc + '%' : null; } } }, scales: isPie ? {} : { x: { ticks: { color: '#a9b6d6', font: { size: 10 } } }, y: { ticks: { color: '#a9b6d6' } } } }
    });
  };
  config('historyChart', 'line', cachedData.history.map(d=>d.date), cachedData.history.map(d=>d.val), false);
  config('assetsChart', 'doughnut', cachedData.assets.map(d=>d.name), cachedData.assets.map(d=>d.value), true);
  config('regionsChart', 'doughnut', cachedData.regions.map(d=>d.name), cachedData.regions.map(d=>d.value), true);
}

function quick(n,s,p){ document.getElementById('name').value=n; document.getElementById('symbol').value=s; document.getElementById('platform').value=p; }

function submitTrade() {
  const name = document.getElementById('name').value.trim();
  const btn = document.querySelector('button.primary');
  btn.disabled = true;
  scriptRun.withSuccessHandler(() => { btn.disabled = false; }).saveTrades({});
}

function showToast(m) { const el = document.getElementById('msg'); el.innerText = m; el.className = "toast info"; setTimeout(() => el.className = "toast", 3000); }

function toggleAI() { const win = document.getElementById('ai-window'); win.style.display = win.style.display === 'flex' ? 'none' : 'flex'; }

function sendChat() {
  const input = document.getElementById('ai-input');
  const text = input.value.trim(); if(!text) return;
  appendMsg(text, 'user'); input.value = '';
  const id = 'msg-' + Date.now();
  appendMsg('...', 'mimi', id);
  scriptRun.withSuccessHandler(res => { document.getElementById(id).innerText = res; }).callGeminiAnalysis(text);
}

function appendMsg(t, type, id) {
  const body = document.getElementById('ai-chat-body');
  const div = document.createElement('div'); div.className = 'msg msg-' + type; div.innerText = t; if(id) div.id = id;
  body.appendChild(div); body.scrollTop = body.scrollHeight;
}

// 🤏 視窗拖曳功能 (支援手機觸控)
function initDraggable() {
  const win = document.getElementById('ai-window');
  const header = document.getElementById('ai-header');
  let isDragging = false;
  let startX, startY, initialLeft, initialTop;

  const dragStart = (e) => {
    if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT') return;
    isDragging = true;
    const clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
    const clientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
    startX = clientX; startY = clientY;
    initialLeft = win.offsetLeft; initialTop = win.offsetTop;
    if (e.type === 'touchstart') document.body.style.overflow = 'hidden';
  };

  const dragMove = (e) => {
    if (!isDragging) return;
    const clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
    const clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
    const dx = clientX - startX; const dy = clientY - startY;
    win.style.left = (initialLeft + dx) + 'px';
    win.style.top = (initialTop + dy) + 'px';
    win.style.right = 'auto'; win.style.bottom = 'auto';
  };

  const dragEnd = () => { isDragging = false; document.body.style.overflow = ''; };

  header.addEventListener('mousedown', dragStart);
  window.addEventListener('mousemove', dragMove);
  window.addEventListener('mouseup', dragEnd);
  header.addEventListener('touchstart', dragStart, { passive: false });
  window.addEventListener('touchmove', dragMove, { passive: false });
  window.addEventListener('touchend', dragEnd);
}
</script>
</body>
</html>