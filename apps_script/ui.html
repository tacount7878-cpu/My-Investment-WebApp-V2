<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>äº¤æ˜“ç´€éŒ„ V6.30</title>

<!-- å¼•å…¥ Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- å¼•å…¥ Chart.js DataLabels æ“´å…… (ç”¨ä¾†é¡¯ç¤º % æ•¸) -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

<style>
:root{
  --bg0:#070b12; --bg1:#0b1220;
  --card:#0f1a2c; --txt:#e8eefc;
  --muted:#a9b6d6; --line:rgba(255,255,255,.08);
  --blue:#2f7bff; --blue2:#1a57c8;
  --red:#ff3b30; --green:#34c759; --shadow: 0 18px 60px rgba(0,0,0,.45);
  --radius:18px;
}
*{box-sizing:border-box;}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",Arial;
  background:linear-gradient(180deg,var(--bg0),var(--bg1));
  color:var(--txt);
  padding:20px;
}
.card{
  max-width:520px;
  margin:auto;
  background:rgba(255,255,255,.05);
  border:1px solid var(--line);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:20px;
}
.title{font-size:22px;font-weight:900;margin-bottom:10px;}
.hint{color:var(--muted);font-size:14px;margin:6px 0;}
.bigInput{
  width:100%;height:60px;font-size:20px;font-weight:800;
  background:rgba(0,0,0,.25);color:white;
  border:1px solid var(--line);
  border-radius:14px;padding:0 14px;
}
.bigInput:focus{
  border-color:var(--blue);
  box-shadow:0 0 0 4px rgba(47,123,255,.2);
}

/* éš±è—æ•¸å­—è¼¸å…¥æ¡†çš„ä¸Šä¸‹ç®­é ­ */
input[type="number"]::-webkit-outer-spin-button,
input[type="number"]::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}
input[type="number"] {
  -moz-appearance: textfield;
}

.chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;}
.chip{
  padding:8px 12px;border-radius:999px;
  background:rgba(47,123,255,.15);
  border:1px solid rgba(47,123,255,.35);
  font-size:13px;font-weight:800;
  cursor:pointer;
}
button.primary{
  width:100%;height:60px;
  margin-top:16px;
  border-radius:16px;
  background:linear-gradient(180deg,var(--blue),var(--blue2));
  border:none;color:white;
  font-size:18px;font-weight:900;
  cursor:pointer;
}
.toast{ margin-top:12px;font-weight:800; text-align:center; }

/* è¦–åœ–åˆ‡æ›èˆ‡æŒ‰éˆ•æ¨£å¼ */
.view { display: none; animation: fadeIn 0.3s ease; }
.view.active { display: block; }
@keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

.btn-group { display:flex; gap:10px; margin-bottom:16px; max-width:520px; margin-left:auto; margin-right:auto; }
button.secondary{
  flex:1; height:50px;
  border-radius:14px;
  background:rgba(255,255,255,0.1);
  border:1px solid var(--line); color:white;
  font-size:15px; font-weight:800;
  display:flex; align-items:center; justify-content:center; gap:6px;
  cursor:pointer; transition:0.2s;
}
button.secondary:active{ background:rgba(255,255,255,0.2); transform:scale(0.98); }
button.action-btn { background:rgba(47,123,255,0.2); border-color:rgba(47,123,255,0.5); color:#8bb4ff;}

/* åœ–è¡¨èˆ‡è¨ˆç®—æ©Ÿå°ˆå±¬æ¨£å¼ */
.chart-card { background:rgba(0,0,0,0.2); border-radius:14px; padding:15px; margin-bottom:16px; border:1px solid var(--line);}
.chart-title { font-size:16px; font-weight:800; margin-bottom:12px; text-align:center; color:var(--txt);}
.chart-container{ position:relative; height:240px; width:100%; }

.calc-row { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; padding-bottom:12px; border-bottom:1px solid var(--line); }
.calc-label { font-size:15px; color:var(--muted); font-weight:700;}
.calc-value { font-size:18px; font-weight:900; color:white; }
.calc-input { width:140px; height:40px; font-size:18px; font-weight:800; text-align:right; background:rgba(0,0,0,0.4); border:1px solid var(--line); border-radius:8px; color:white; padding:0 10px;}
.calc-input:focus { border-color:var(--blue); outline:none; }

.final-networth {
  background: linear-gradient(135deg, rgba(52,199,89,0.15), rgba(52,199,89,0.05));
  border: 1px solid rgba(52,199,89,0.4);
  border-radius: 16px; padding: 20px; text-align: center; margin-top: 20px;
}
.final-label { color: #a3e4b5; font-size: 14px; font-weight: 800; margin-bottom: 8px; }
.final-val { color: #34c759; font-size: 36px; font-weight: 900; font-variant-numeric: tabular-nums; }

#loading-overlay{ font-size:14px; color:var(--muted); text-align:center; padding:40px 0; }
#env-tag { position: fixed; top: 10px; right: 10px; font-size: 10px; color: var(--muted); opacity: 0.5; z-index:999;}
.update-indicator { font-size:12px; color:var(--green); text-align:center; margin-bottom:15px; font-weight:700; opacity:0; transition:opacity 0.3s;}
</style>
</head>

<body>

<div id="env-tag">Mode: Detecting...</div>

<!-- ================= è¦–åœ– 1ï¼šè¼¸å…¥è¡¨å–® ================= -->
<div id="view-input" class="view active">
  <div class="btn-group">
    <button class="secondary" onclick="switchView('dashboard')">ğŸ“Š æˆ°æƒ…åœ–è¡¨</button>
    <button class="secondary" onclick="switchView('networth')">ğŸ’° å³æ™‚ç¸½è³‡ç”¢</button>
  </div>

  <div class="card">
    <div class="title">äº¤æ˜“ç´€éŒ„</div>

    <div class="hint">äº¤æ˜“é¡å‹</div>
    <select id="type" class="bigInput">
      <option value="è²·å…¥">è²·å…¥</option>
      <option value="è³£å‡º">è³£å‡º</option>
    </select>

    <div class="hint">æ¨™çš„åç¨±ï¼ˆå¿…å¡«ï¼‰</div>
    <input id="name" class="bigInput" placeholder="ä¾‹å¦‚ï¼šå¯Œé‚¦å°50">

    <div class="hint">è‚¡ç¥¨ä»£è™Ÿ</div>
    <input id="symbol" class="bigInput" placeholder="ä¾‹å¦‚ï¼š006208.TW">

    <div class="hint">å¸¸ç”¨å¿«é¸</div>
    <div class="chips">
      <div class="chip" onclick="quick('å¯Œé‚¦å°50','006208.TW','å…ƒå¤§(å°è‚¡)')">å¯Œé‚¦å°50</div>
      <div class="chip" onclick="quick('å°ç©é›»','2330.TW','å…ƒå¤§(å°è‚¡)')">å°ç©é›»</div>
      <div class="chip" onclick="quick('VWRAå…¨çƒè‚¡ç¥¨','VWRA.L','IBKR')">VWRA</div>
      <div class="chip" onclick="quick('ç‰¹æ–¯æ‹‰(FT)','TSLA','Firstrade(FT)')">TSLA(FT)</div>
      <div class="chip" onclick="quick('æ¯”ç‰¹å¹£','BTC-USD','éŒ¢åŒ…')">æ¯”ç‰¹å¹£</div>
    </div>

    <div class="hint">åƒ¹æ ¼</div>
    <input id="price" class="bigInput" type="number" step="any" inputmode="decimal">

    <div class="hint">è‚¡æ•¸</div>
    <input id="qty" class="bigInput" type="number" step="any" inputmode="decimal">

    <div class="hint">æ‰‹çºŒè²»</div>
    <input id="fee" class="bigInput" type="number" step="any" placeholder="æœªå¡«è‡ªå‹• 0" inputmode="decimal">

    <div class="hint">äº¤æ˜“ç¨…</div>
    <input id="tax" class="bigInput" type="number" step="any" placeholder="æœªå¡«è‡ªå‹• 0" inputmode="decimal">

    <div class="hint">æˆæœ¬ï¼ˆè³£å‡ºå¿…å¡«ï¼‰</div>
    <input id="cost" class="bigInput" type="number" step="any" inputmode="decimal">

    <div class="hint">å¹³å°</div>
    <select id="platform" class="bigInput">
      <option value="å…ƒå¤§(å°è‚¡)">å…ƒå¤§(å°è‚¡)</option>
      <option value="å…ƒå¤§è¤‡å§”è¨—(ç¾è‚¡)">å…ƒå¤§è¤‡å§”è¨—(ç¾è‚¡)</option>
      <option value="Firstrade(FT)">Firstrade(FT)</option>
      <option value="IBKR">IBKR</option>
      <option value="éŒ¢åŒ…">éŒ¢åŒ…</option>
    </select>

    <div class="hint">å¸³æˆ¶é¡å‹</div>
    <select id="account" class="bigInput">
      <option value="TWDå¸³æˆ¶">TWDå¸³æˆ¶</option>
      <option value="USDå¤–å¹£å¸³æˆ¶">USDå¤–å¹£å¸³æˆ¶</option>
      <option value="å…¶ä»–">å…¶ä»–</option>
    </select>

    <button class="primary" onclick="submitTrade()">é€å‡ºäº¤æ˜“</button>
    <div id="msg" class="toast"></div>
  </div>
</div>

<!-- ================= è¦–åœ– 2ï¼šåœ–è¡¨å„€è¡¨æ¿ ================= -->
<div id="view-dashboard" class="view">
  <div class="btn-group">
    <button class="secondary" onclick="switchView('input')">ğŸ”™ æ–°å¢äº¤æ˜“</button>
    <button class="secondary action-btn" onclick="refreshDashboard(false)">ğŸ”„ æ‰‹å‹•æ›´æ–°</button>
  </div>

  <div class="card">
    <div class="title">æˆ°æƒ…å„€è¡¨æ¿</div>
    <div id="update-msg-dash" class="update-indicator">âœ¨ æ•¸æ“šå·²æ›´æ–°</div>
    
    <div id="loading-overlay-dash">æ•¸æ“šè¼‰å…¥ä¸­...</div>
    
    <div id="dashboard-content" style="display:none;">
      <div class="chart-card">
        <div class="chart-title">è³‡ç”¢ç¸½æ·¨å€¼ (TWD)</div>
        <div class="chart-container"><canvas id="historyChart"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-title">æŒå€‰ä½”æ¯” (åˆä½µå¾Œ)</div>
        <div class="chart-container"><canvas id="assetsChart"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-title">æŠ•è³‡åœ°å€åˆ†ä½ˆ</div>
        <div class="chart-container"><canvas id="regionsChart"></canvas></div>
      </div>
    </div>
  </div>
</div>

<!-- ================= è¦–åœ– 3ï¼šå³æ™‚ç¸½è³‡ç”¢ ================= -->
<div id="view-networth" class="view">
  <div class="btn-group">
    <button class="secondary" onclick="switchView('input')">ğŸ”™ æ–°å¢äº¤æ˜“</button>
    <button class="secondary action-btn" onclick="refreshDashboard(false)">ğŸ”„ æ‰‹å‹•æ›´æ–°</button>
  </div>

  <div class="card">
    <div class="title">ğŸ’° å³æ™‚ç¸½è³‡ç”¢</div>
    <div id="update-msg-net" class="update-indicator">âœ¨ æ•¸æ“šå·²æ›´æ–°</div>
    
    <div id="loading-overlay-net">æ•¸æ“šè¼‰å…¥ä¸­...</div>

    <div id="networth-content" style="display:none;">
      
      <!-- å¾Œå°è‡ªå‹•å¸¶å…¥å€ -->
      <div class="chart-card" style="border-color:rgba(47,123,255,0.3);">
        <div class="calc-row">
          <div class="calc-label">ğŸ“Š æŠ•è³‡éƒ¨ä½ç¸½å¸‚å€¼ (TWD)</div>
          <div class="calc-value" id="val-invest">0</div>
        </div>
        <div class="calc-row">
          <div class="calc-label">ğŸ“ˆ ç›®å‰å ±é…¬ç‡ (å·²å¯¦ç¾)</div>
          <div class="calc-value" id="val-return" style="color:var(--green);">0.00%</div>
        </div>
        <div class="calc-row">
          <div class="calc-label">ğŸ’µ å·²å¯¦ç¾ç¸½æç›Š (TWD)</div>
          <div class="calc-value" id="val-realized-twd" style="color:var(--green);">0</div>
        </div>
        <div class="calc-row" style="border:none; margin-bottom:0; padding-bottom:0;">
          <div class="calc-label">ğŸ’± å³æ™‚åŒ¯ç‡ (USD/TWD)</div>
          <div class="calc-value" id="val-usdrate" style="color:var(--muted);">32.00</div>
        </div>
      </div>

      <!-- æ‰‹å‹•è¼¸å…¥å€ (å·²è¨­å®š inputmode="decimal" æ”¯æ´å°æ•¸é») -->
      <div class="hint" style="margin-top:20px; margin-bottom:10px;">è¼¸å…¥ç›®å‰å¸³æˆ¶é¤˜é¡</div>
      
      <div class="calc-row">
        <div class="calc-label">ç›®å‰å¸³æˆ¶ç¾é‡‘ (TWD)</div>
        <input type="number" id="inp-cash-twd" class="calc-input" placeholder="0" inputmode="decimal" oninput="calcTotalNetWorth()">
      </div>
      <div class="calc-row">
        <div class="calc-label">äº¤å‰²ä¸­ç¾é‡‘ (TWD)</div>
        <input type="number" id="inp-settle-twd" class="calc-input" placeholder="0" inputmode="decimal" oninput="calcTotalNetWorth()">
      </div>
      <div class="calc-row">
        <div class="calc-label">ç¾å…ƒç¾é‡‘ (USD)</div>
        <input type="number" id="inp-cash-usd" class="calc-input" placeholder="0" inputmode="decimal" oninput="calcTotalNetWorth()">
      </div>
      <div class="calc-row" style="border-color:rgba(255,59,48,0.3);">
        <div class="calc-label" style="color:#ff6b6b;">ç›®å‰è²¸æ¬¾é‡‘é¡ (TWD)</div>
        <input type="number" id="inp-loan-twd" class="calc-input" placeholder="0" inputmode="decimal" oninput="calcTotalNetWorth()" style="color:#ff6b6b;">
      </div>

      <!-- æœ€çµ‚çµæœ -->
      <div class="final-networth">
        <div class="final-label">è³‡ç”¢ç¸½æ·¨å€¼ (æ‰£é™¤è²¸æ¬¾)</div>
        <div class="final-val" id="val-final-networth">0</div>
      </div>

    </div>
  </div>
</div>

<script>
// è¨»å†Šç™¾åˆ†æ¯”æ“´å……
Chart.register(ChartDataLabels);

const isGasEnv = typeof google !== 'undefined' && google.script && google.script.run;
document.getElementById('env-tag').innerText = isGasEnv ? "Mode: GAS Online" : "Mode: Preview Simulator";

const scriptRun = isGasEnv ? google.script.run : {
  withSuccessHandler: function(cb) {
    return {
      withFailureHandler: function() {
        return {
          getDashboardData: () => {
            setTimeout(() => cb({
              history: [{date:'1/30', val:5283226}, {date:'2/2', val:5293960}, {date:'2/9', val:5406320}],
              assets: [{name:'0050/006208', value:2218500}, {name:'å°è‚¡å‚µåˆ¸', value:851020}, {name:'VT/VWRA', value:2323671}],
              regions: [{name:'å°è‚¡', value:2579685}, {name:'ç¾è‚¡', value:801083}],
              investTotal: 6797152, usdRate: 32.2, realizedReturn: 22.29, realizedReturnTwd: 242988 
            }), 400);
          },
          saveTrades: () => setTimeout(() => cb({ ok: true, row: 99 }), 600)
        };
      }
    };
  }
};

let historyChart, assetsChart, regionsChart;
let isDataLoaded = false; 
let cachedData = null; 
let currentInvestTotal = 0;
let currentUsdRate = 32.0;

// ====== 0. è®€å– LocalStorage ç´€éŒ„ ======
window.onload = () => {
  const savedCashTwd = localStorage.getItem('wr_cash_twd');
  const savedSettleTwd = localStorage.getItem('wr_settle_twd');
  const savedCashUsd = localStorage.getItem('wr_cash_usd');
  const savedLoanTwd = localStorage.getItem('wr_loan_twd');

  if(savedCashTwd) document.getElementById('inp-cash-twd').value = savedCashTwd;
  if(savedSettleTwd) document.getElementById('inp-settle-twd').value = savedSettleTwd;
  if(savedCashUsd) document.getElementById('inp-cash-usd').value = savedCashUsd;
  if(savedLoanTwd) document.getElementById('inp-loan-twd').value = savedLoanTwd;
  
  calcTotalNetWorth(); 
};

// ====== 1. è¦–åœ–åˆ‡æ› ======
function switchView(viewName) {
  document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
  document.getElementById('view-' + viewName).classList.add('active');
  window.scrollTo(0, 0); 
  
  if(viewName === 'dashboard' || viewName === 'networth') {
    if(!isDataLoaded) {
      refreshDashboard(false);
    } else if(viewName === 'dashboard' && cachedData) {
      setTimeout(() => {
        renderHistory(cachedData.history || [], false);
        renderPieChart('assetsChart', cachedData.assets || [], false);
        renderPieChart('regionsChart', cachedData.regions || [], false);
      }, 50);
    }
  }
}

// ====== 2. è³‡æ–™æ›´æ–°é‚è¼¯ (é‡é»ï¼šæ‰“åŒ… inputs å‚³çµ¦å¾Œç«¯) ======
function refreshDashboard(isSilent = false) {
  if(!isSilent) {
    document.getElementById('loading-overlay-dash').style.display = 'block';
    document.getElementById('dashboard-content').style.display = 'none';
    document.getElementById('loading-overlay-net').style.display = 'block';
    document.getElementById('networth-content').style.display = 'none';
  }

  // ğŸ“¦ æ”¶é›† UI è¼¸å…¥å€¼
  const inputs = {
    cashTwd: document.getElementById('inp-cash-twd').value,
    settleTwd: document.getElementById('inp-settle-twd').value,
    cashUsd: document.getElementById('inp-cash-usd').value,
    loanTwd: document.getElementById('inp-loan-twd').value
  };

  scriptRun
    .withSuccessHandler(data => {
      cachedData = data;
      isDataLoaded = true;

      if(!isSilent) {
        document.getElementById('loading-overlay-dash').style.display = 'none';
        document.getElementById('dashboard-content').style.display = 'block';
        document.getElementById('loading-overlay-net').style.display = 'none';
        document.getElementById('networth-content').style.display = 'block';
      }
      
      currentInvestTotal = data.investTotal || 0;
      currentUsdRate = data.usdRate || 32.0;
      
      document.getElementById('val-invest').innerText = currentInvestTotal.toLocaleString('zh-TW', {maximumFractionDigits:0});
      document.getElementById('val-usdrate').innerText = currentUsdRate.toFixed(2);
      
      const ret = data.realizedReturn || 0;
      const retEl = document.getElementById('val-return');
      retEl.innerText = (ret > 0 ? '+' : '') + ret.toFixed(2) + '%';
      retEl.style.color = ret >= 0 ? 'var(--green)' : 'var(--red)';

      const retTwd = data.realizedReturnTwd || 0;
      const retTwdEl = document.getElementById('val-realized-twd');
      retTwdEl.innerText = (retTwd > 0 ? '+' : '') + retTwd.toLocaleString('zh-TW', {maximumFractionDigits:0});
      retTwdEl.style.color = retTwd >= 0 ? 'var(--green)' : 'var(--red)';
      
      calcTotalNetWorth();
      showUpdateIndicator();

      if(document.getElementById('view-dashboard').classList.contains('active')) {
        setTimeout(() => {
          renderHistory(data.history || [], isSilent);
          renderPieChart('assetsChart', data.assets || [], isSilent);
          renderPieChart('regionsChart', data.regions || [], isSilent);
        }, 50);
      }
    })
    .withFailureHandler(err => {
      if(!isSilent) alert("æ•¸æ“šè¼‰å…¥å¤±æ•—: " + err.message);
    })
    .getDashboardData(inputs); // ğŸš€ ç™¼é€ï¼
}

function showUpdateIndicator() {
  const msg1 = document.getElementById('update-msg-dash');
  const msg2 = document.getElementById('update-msg-net');
  msg1.style.opacity = 1; msg2.style.opacity = 1;
  setTimeout(() => { msg1.style.opacity = 0; msg2.style.opacity = 0; }, 2000);
}

// ====== 3. å®šæ™‚è‡ªå‹•æ›´æ–° ======
setInterval(() => { if(isDataLoaded) refreshDashboard(true); }, 60000); 

// ====== 4. ç¸½è³‡ç”¢çµç®—è¨ˆç®—æ©Ÿ (åŒ…å«è‡ªå‹•å„²å­˜) ======
function calcTotalNetWorth() {
  const cashTwd = Number(document.getElementById('inp-cash-twd').value) || 0;
  const settleTwd = Number(document.getElementById('inp-settle-twd').value) || 0;
  const cashUsd = Number(document.getElementById('inp-cash-usd').value) || 0;
  const loanTwd = Number(document.getElementById('inp-loan-twd').value) || 0;

  // è‡ªå‹•å¯«å…¥ LocalStorage
  localStorage.setItem('wr_cash_twd', document.getElementById('inp-cash-twd').value);
  localStorage.setItem('wr_settle_twd', document.getElementById('inp-settle-twd').value);
  localStorage.setItem('wr_cash_usd', document.getElementById('inp-cash-usd').value);
  localStorage.setItem('wr_loan_twd', document.getElementById('inp-loan-twd').value);

  const finalNetWorth = currentInvestTotal + cashTwd + settleTwd + (cashUsd * currentUsdRate) - loanTwd;
  document.getElementById('val-final-networth').innerText = finalNetWorth.toLocaleString('zh-TW', {maximumFractionDigits:0});
}

// ====== 5. ç¹ªè£½åœ–è¡¨å‡½æ•¸ (ç¶­æŒä¸è®Š) ======
function renderHistory(history, isSilent) {
  if(history.length === 0) return;
  if (isSilent && historyChart) {
    historyChart.data.labels = history.map(d => d.date);
    historyChart.data.datasets[0].data = history.map(d => d.val);
    historyChart.update();
    return;
  }
  const ctx = document.getElementById('historyChart').getContext('2d');
  if(historyChart) historyChart.destroy();
  
  historyChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: history.map(d => d.date),
      datasets: [{
        label: 'ç¸½æ·¨å€¼',
        data: history.map(d => d.val),
        borderColor: '#2f7bff', backgroundColor: 'rgba(47,123,255,0.1)',
        fill: true, tension: 0.4, pointBackgroundColor: '#2f7bff', pointRadius: 2
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      animation: { duration: 2000, easing: 'easeOutQuart' },
      plugins: { legend: { display: false }, datalabels: { display: false } },
      scales: {
        x: { grid: { display: false }, ticks: { color: '#a9b6d6', maxRotation: 45 } },
        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#a9b6d6', callback: function(v) { return v.toLocaleString(); } } }
      }
    }
  });
}

function renderPieChart(canvasId, dataArray, isSilent) {
  if(dataArray.length === 0) return;
  let existingChart = canvasId === 'assetsChart' ? assetsChart : regionsChart;
  if (isSilent && existingChart) {
    existingChart.data.labels = dataArray.map(d => d.name);
    existingChart.data.datasets[0].data = dataArray.map(d => d.value);
    existingChart.update();
    return;
  }
  const ctx = document.getElementById(canvasId).getContext('2d');
  if(existingChart) existingChart.destroy();

  const colors = ['#4285F4', '#34A853', '#FBBC05', '#EA4335', '#00BCD4', '#8E24AA', '#FF9800', '#9E9E9E'];
  const newChart = new Chart(ctx, {
    type: 'doughnut', 
    data: {
      labels: dataArray.map(d => d.name),
      datasets: [{
        data: dataArray.map(d => d.value),
        backgroundColor: colors.slice(0, dataArray.length),
        borderWidth: 2, borderColor: '#0f1a2c'    
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false, cutout: '55%',              
      animation: { animateRotate: true, animateScale: true, duration: 2000, easing: 'easeOutQuart' },
      plugins: {
        legend: { position: 'right', labels: { color: '#e8eefc', boxWidth: 12, font: { size: 11 } } },
        tooltip: { callbacks: { label: function(c) { return `${c.label}: $${c.raw.toLocaleString()}`; } } },
        datalabels: {
          color: '#ffffff', font: { weight: 'bold', size: 11 },
          formatter: (value, ctx) => {
            let sum = 0;
            ctx.chart.data.datasets[0].data.map(d => { sum += d; });
            if ((value * 100 / sum) < 4) return null;
            return (value * 100 / sum).toFixed(1) + "%";
          }
        }
      }
    }
  });

  if(canvasId === 'assetsChart') assetsChart = newChart;
  if(canvasId === 'regionsChart') regionsChart = newChart;
}

// ====== 6. è¡¨å–®é‚è¼¯ (ç¶­æŒä¸è®Š) ======
function quick(name,symbol,platform){
  document.getElementById("name").value=name;
  document.getElementById("symbol").value=symbol;
  document.getElementById("platform").value=platform;
}

function submitTrade(){
  const name=document.getElementById("name").value.trim();
  const type=document.getElementById("type").value;
  const cost=document.getElementById("cost").value;

  if(!name){ show("âŒ åç¨±ä¸å¯ç©ºç™½"); return; }
  if(type==="è³£å‡º" && !cost){ show("âŒ è³£å‡ºå¿…é ˆå¡«æˆæœ¬"); return; }

  show("â³ å¯«å…¥ä¸­...");
  const btn = document.querySelector('button.primary');
  btn.disabled = true;

  const payload={
    defaults:{ platform:document.getElementById("platform").value, account:document.getElementById("account").value },
    trades:[{
      type:type, name:name, symbol:document.getElementById("symbol").value,
      price:Number(document.getElementById("price").value||0),
      qty:Number(document.getElementById("qty").value||0),
      fee:Number(document.getElementById("fee").value||0),
      tax:Number(document.getElementById("tax").value||0),
      cost:Number(cost||0),
      date:new Date().toLocaleDateString('zh-TW')
    }]
  };

  scriptRun
    .withSuccessHandler(res=>{
      show("âœ… æˆåŠŸå¯«å…¥ç¬¬ "+res.row+" åˆ—");
      clearForm();
      btn.disabled = false;
      isDataLoaded = false; 
    })
    .withFailureHandler(err=>{
      show("âŒ "+err.message);
      btn.disabled = false;
    })
    .saveTrades(payload);
}

function show(msg){ document.getElementById("msg").innerText=msg; }
function clearForm(){ ["name","symbol","price","qty","fee","tax","cost"].forEach(id=>{ document.getElementById(id).value=""; }); }
</script>

</body>
</html>