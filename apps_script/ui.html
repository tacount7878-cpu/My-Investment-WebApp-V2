<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>äº¤æ˜“ç´€éŒ„ V6.46 - ä¿®æ­£ç‰ˆ</title>

<!-- å¼•å…¥ Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- å¼•å…¥ Chart.js DataLabels æ“´å…… -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

<style>
:root{
  --bg0:#070b12; --bg1:#0b1220;
  --card:#0f1a2c; --txt:#e8eefc;
  --muted:#a9b6d6; --line:rgba(255,255,255,.08);
  --blue:#2f7bff; --blue2:#1a57c8;
  --red:#ff3b30; --green:#34c759; --shadow: 0 18px 60px rgba(0,0,0,.45);
  --radius:18px;
  --purple: #6e45e2; --purple2: #88d3ce;
}
*{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",Arial;
  background:linear-gradient(180deg,var(--bg0),var(--bg1));
  color:var(--txt);
  padding:20px;
  min-height: 100vh;
  overflow-x: hidden;
}
.card{
  max-width:520px;
  margin:auto;
  background:rgba(255,255,255,.05);
  border:1px solid var(--line);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:20px;
  margin-bottom: 80px;
}
.title{font-size:22px;font-weight:900;margin-bottom:10px;}
.hint{color:var(--muted);font-size:14px;margin:12px 0 6px 0;}
.bigInput{
  width:100%;height:60px;font-size:20px;font-weight:800;
  background:rgba(0,0,0,.25);color:white;
  border:1px solid var(--line);
  border-radius:14px;padding:0 14px;
}
.bigInput:focus{ border-color:var(--blue); outline:none; box-shadow:0 0 0 4px rgba(47,123,255,.2); }

input[type="number"]::-webkit-outer-spin-button,
input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
input[type="number"] { -moz-appearance: textfield; }

.chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;}
.chip{ padding:8px 12px;border-radius:999px; background:rgba(47,123,255,.15); border:1px solid rgba(47,123,255,.35); font-size:13px;font-weight:800; cursor:pointer; }

button.primary{ width:100%;height:60px; margin-top:24px; border-radius:16px; background:linear-gradient(180deg,var(--blue),var(--blue2)); border:none;color:white; font-size:18px;font-weight:900; cursor:pointer; }
.toast{ margin-top:12px;font-weight:800; text-align:center; padding: 10px; border-radius: 8px; display: none; }
.toast.info { display: block; background: rgba(47,123,255,0.2); color: #8bb4ff; }

.view { display: none; animation: fadeIn 0.3s ease; }
.view.active { display: block; }
@keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

.btn-group { display:flex; gap:10px; margin-bottom:16px; max-width:520px; margin-left:auto; margin-right:auto; }
button.secondary{ flex:1; height:50px; border-radius:14px; background:rgba(255,255,255,0.1); border:1px solid var(--line); color:white; font-size:15px; font-weight:800; cursor:pointer; transition:0.2s; }
button.action-btn { background:rgba(47,123,255,0.2); border-color:rgba(47,123,255,0.5); color:#8bb4ff;}

#ai-fab {
  position: fixed; bottom: 30px; right: 20px;
  width: 68px; height: 68px; border-radius: 50%;
  background: linear-gradient(135deg, var(--purple), var(--purple2));
  box-shadow: 0 10px 30px rgba(110, 69, 226, 0.6);
  display: flex; align-items: center; justify-content: center;
  font-size: 32px; cursor: pointer; z-index: 9999;
}

#ai-window {
  position: fixed; top: 15%; left: 5%;
  width: 90%; max-width: 400px; height: 500px;
  background: rgba(22, 27, 34, 0.9);
  backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
  border-radius: 28px; border: 1px solid rgba(110, 69, 226, 0.4);
  box-shadow: 0 30px 80px rgba(0,0,0,0.7);
  z-index: 10000; display: none; flex-direction: column;
  overflow: hidden;
}
#ai-header { padding: 16px 20px; background: rgba(110, 69, 226, 0.25); display: flex; justify-content: space-between; align-items: center; cursor: move; border-bottom: 1px solid rgba(255,255,255,0.1); }
#ai-chat-body { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 14px; }
.msg { max-width: 85%; padding: 12px 16px; border-radius: 20px; font-size: 15px; line-height: 1.6; }
.msg-mimi { align-self: flex-start; background: rgba(255,255,255,0.1); color: #e8eefc; }
.msg-user { align-self: flex-end; background: var(--purple); color: white; }
#ai-footer { padding: 15px; display: flex; gap: 10px; border-top: 1px solid rgba(255,255,255,0.1); }
#ai-input { flex: 1; background: rgba(255,255,255,0.08); border: 1px solid var(--line); border-radius: 14px; color: white; padding: 12px; outline: none; }
#ai-send { width: 48px; height: 48px; background: var(--purple); border: none; border-radius: 12px; color: white; cursor: pointer; }

.chart-card { background:rgba(0,0,0,0.2); border-radius:14px; padding:15px; margin-bottom:16px; border:1px solid var(--line);}
.chart-title { font-size:16px; font-weight:800; margin-bottom:12px; text-align:center; color:var(--txt);}
.chart-container{ position:relative; height:240px; width:100%; }

.calc-row { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; padding-bottom:12px; border-bottom:1px solid var(--line); }
.calc-value { font-size:18px; font-weight:900; color:white; }
.calc-input { width:140px; height:40px; font-size:18px; font-weight:800; text-align:right; background:rgba(0,0,0,0.4); border:1px solid var(--line); border-radius:8px; color:white; padding:0 10px;}

.final-networth { background: linear-gradient(135deg, rgba(52,199,89,0.15), rgba(52,199,89,0.05)); border: 1px solid rgba(52,199,89,0.4); border-radius: 16px; padding: 20px; text-align: center; margin-top: 20px; }
.final-val { color: #34c759; font-size: 36px; font-weight: 900; }

.update-indicator { font-size:12px; color:var(--green); text-align:center; margin-bottom:15px; font-weight:700; opacity:0; transition:opacity 0.3s;}
</style>
</head>

<body>

<div id="ai-fab" onclick="toggleAI()">ğŸ¤–</div>

<div id="ai-window">
  <div id="ai-header">
    <div class="ai-title">ğŸ¤– å’ªå’ªæˆ°æƒ…åˆ†æ</div>
    <button style="background:none; border:none; color:white; font-size:24px;" onclick="toggleAI()">Ã—</button>
  </div>
  <div id="ai-chat-body">
    <div class="msg msg-mimi">å—¨ï¼Œç¿”ç¿”ã€‚ğŸ˜Š</div>
  </div>
  <div id="ai-footer">
    <input type="text" id="ai-input" placeholder="è¼¸å…¥å•é¡Œ..." onkeypress="if(event.keyCode==13) sendChat()">
    <button id="ai-send" onclick="sendChat()">â¤</button>
  </div>
</div>

<div id="view-input" class="view active">
  <div class="btn-group">
    <button class="secondary" onclick="switchView('dashboard')">ğŸ“Š æˆ°æƒ…åœ–è¡¨</button>
    <button class="secondary" onclick="switchView('networth')">ğŸ’° å³æ™‚ç¸½è³‡ç”¢</button>
  </div>

  <div class="card">
    <div class="title">äº¤æ˜“ç´€éŒ„</div>
    
    <div class="hint">äº¤æ˜“é¡å‹</div>
    <select id="type" class="bigInput">
      <option value="è²·å…¥">è²·å…¥</option>
      <option value="è³£å‡º">è³£å‡º</option>
    </select>

    <div class="hint">æ¨™çš„åç¨±</div>
    <input id="name" class="bigInput" placeholder="ä¾‹å¦‚ï¼šå¯Œé‚¦å°50">

    <div class="hint">è‚¡ç¥¨ä»£è™Ÿ</div>
    <input id="symbol" class="bigInput" placeholder="ä¾‹å¦‚ï¼š006208.TW">

    <div class="hint">å¸¸ç”¨å¿«é¸</div>
    <div class="chips">
      <div class="chip" onclick="quick('å¯Œé‚¦å°50','006208.TW','å…ƒå¤§(å°è‚¡)')">å¯Œé‚¦å°50</div>
      <div class="chip" onclick="quick('å°ç©é›»','2330.TW','å…ƒå¤§(å°è‚¡)')">å°ç©é›»</div>
      <div class="chip" onclick="quick('VWRA','VWRA.L','IBKR')">VWRA</div>
      <div class="chip" onclick="quick('TSLA(FT)','TSLA','Firstrade(FT)')">TSLA(FT)</div>
      <div class="chip" onclick="quick('æ¯”ç‰¹å¹£','BTC-USD','éŒ¢åŒ…')">æ¯”ç‰¹å¹£</div>
    </div>

    <div class="hint">åƒ¹æ ¼</div>
    <input id="price" class="bigInput" type="number" step="any" inputmode="decimal">

    <div class="hint">è‚¡æ•¸</div>
    <input id="qty" class="bigInput" type="number" step="any" inputmode="decimal">

    <div class="hint">æ‰‹çºŒè²»</div>
    <input id="fee" class="bigInput" type="number" step="any" placeholder="æœªå¡«è‡ªå‹• 0" inputmode="decimal">

    <div class="hint">äº¤æ˜“ç¨…</div>
    <input id="tax" class="bigInput" type="number" step="any" placeholder="æœªå¡«è‡ªå‹• 0" inputmode="decimal">

    <div class="hint">æˆæœ¬ï¼ˆè³£å‡ºå¿…å¡«ï¼‰</div>
    <input id="cost" class="bigInput" type="number" step="any" inputmode="decimal">

    <div class="hint">å¹³å°</div>
    <select id="platform" class="bigInput">
      <option value="å…ƒå¤§(å°è‚¡)">å…ƒå¤§(å°è‚¡)</option>
      <option value="å…ƒå¤§è¤‡å§”è¨—(ç¾è‚¡)">å…ƒå¤§è¤‡å§”è¨—(ç¾è‚¡)</option>
      <option value="Firstrade(FT)">Firstrade(FT)</option>
      <option value="IBKR">IBKR</option>
      <option value="éŒ¢åŒ…">éŒ¢åŒ…</option>
    </select>

    <div class="hint">å¸³æˆ¶é¡å‹</div>
    <select id="account" class="bigInput">
      <option value="TWDå¸³æˆ¶">TWDå¸³æˆ¶</option>
      <option value="USDå¤–å¹£å¸³æˆ¶">USDå¤–å¹£å¸³æˆ¶</option>
      <option value="å…¶ä»–">å…¶ä»–</option>
    </select>

    <button class="primary" onclick="submitTrade()">é€å‡ºäº¤æ˜“</button>
    <div id="msg" class="toast"></div>
  </div>
</div>

<div id="view-dashboard" class="view">
  <div class="btn-group">
    <button class="secondary" onclick="switchView('input')">ğŸ”™ è¿”å›</button>
    <button class="secondary action-btn" onclick="refreshDashboard(false)">ğŸ”„ æ‰‹å‹•æ›´æ–°</button>
  </div>
  <div class="card">
    <div class="title">æˆ°æƒ…å„€è¡¨æ¿</div>
    <div id="update-msg-dash" class="update-indicator">âœ¨ æ•¸æ“šå·²æ›´æ–°</div>
    <div id="loading-overlay-dash" style="text-align:center; padding:40px;">æ•¸æ“šè¼‰å…¥ä¸­...</div>
    <div id="dashboard-content" style="display:none;">
      <div class="chart-card"><div class="chart-title">è³‡ç”¢ç¸½æ·¨å€¼ (TWD)</div><div class="chart-container"><canvas id="historyChart"></canvas></div></div>
      <div class="chart-card"><div class="chart-title">æŒå€‰ä½”æ¯” (åˆä½µå¾Œ)</div><div class="chart-container"><canvas id="assetsChart"></canvas></div></div>
      <div class="chart-card"><div class="chart-title">æŠ•è³‡åœ°å€åˆ†ä½ˆ</div><div class="chart-container"><canvas id="regionsChart"></canvas></div></div>
    </div>
  </div>
</div>

<div id="view-networth" class="view">
  <div class="btn-group">
    <button class="secondary" onclick="switchView('input')">ğŸ”™ è¿”å›</button>
    <button class="secondary action-btn" onclick="refreshDashboard(false)">ğŸ”„ æ‰‹å‹•æ›´æ–°</button>
  </div>
  <div class="card">
    <div class="title">ğŸ’° å³æ™‚ç¸½è³‡ç”¢</div>
    <div id="update-msg-net" class="update-indicator">âœ¨ æ•¸æ“šå·²æ›´æ–°</div>
    <div id="networth-content">
      <div class="chart-card">
        <div class="calc-row"><span>ğŸ“Š æŠ•è³‡éƒ¨ä½å¸‚å€¼</span><span id="val-invest">0</span></div>
        <div class="calc-row"><span>ğŸ“ˆ å ±é…¬ç‡ (å·²å¯¦ç¾)</span><span id="val-return">0%</span></div>
        <div class="calc-row"><span>ğŸ’± å³æ™‚åŒ¯ç‡ (USD)</span><span id="val-usdrate">32.2</span></div>
      </div>
      <div class="hint" style="margin-top:20px;">è¼¸å…¥ç›®å‰çš„å¸³æˆ¶é¤˜é¡</div>
      <div class="calc-row"><span>å°å¹£ç¾é‡‘</span><input type="number" id="inp-cash-twd" class="calc-input" oninput="calcTotalNetWorth()"></div>
      <div class="calc-row"><span>äº¤å‰²ç¾é‡‘</span><input type="number" id="inp-settle-twd" class="calc-input" oninput="calcTotalNetWorth()"></div>
      <div class="calc-row"><span>ç¾é‡‘ç¾é‡‘</span><input type="number" id="inp-cash-usd" class="calc-input" oninput="calcTotalNetWorth()"></div>
      <div class="calc-row" style="color:#ff6b6b;"><span>è²¸æ¬¾é‡‘é¡</span><input type="number" id="inp-loan-twd" class="calc-input" oninput="calcTotalNetWorth()" style="color:#ff6b6b;"></div>
      <div class="final-networth"><div class="final-val" id="val-final-networth">0</div></div>
    </div>
  </div>
</div>

<script>
Chart.register(ChartDataLabels);
const isGasEnv = typeof google !== 'undefined' && google.script && google.script.run;

const scriptRun = isGasEnv ? google.script.run : (() => {
  const mock = {
    _cb: null, withSuccessHandler: function(cb) { this._cb = cb; return this; },
    getDashboardData: function(inputs) {
      setTimeout(() => this._cb({
        history: [
            {date:'01/07', val:5350000}, {date:'01/16', val:5580000}, {date:'01/24', val:5320000}, 
            {date:'01/30', val:5360000}, {date:'02/05', val:5230000}, {date:'02/14', val:5710000}, {date:'02/16', val:5690000}, {date:'02/17', val:5685000}
        ],
        assets: [
            {name:'0050', value:2316000}, {name:'2330', value:381085}, {name:'å‚µåˆ¸(å°è‚¡)', value:1054130},
            {name:'VT/VWRA', value:2310949}, {name:'TSLA (ç‰¹æ–¯æ‹‰)', value:379346}, {name:'Google', value:392013}, {name:'Bitcoin', value:232460}
        ],
        regions: [{name:'å°è‚¡', value:3751215}, {name:'ç¾è‚¡', value:801083}, {name:'å…¨çƒ', value:2310949}, {name:'åŠ å¯†', value:232460}],
        investTotal: 7065983, usdRate: 32.2, realizedReturn: 22.4, realizedReturnTwd: 250000
      }), 500);
    },
    saveTrades: function(p) { setTimeout(() => this._cb({ok:true, row: 88}), 400); },
    callGeminiAnalysis: function(q, d) { setTimeout(() => this._cb("æ¨¡æ“¬ï¼šé…ç½®å·²ç¶“æ›´æ–°ï¼"), 800); }
  };
  return mock;
})();

let charts = {};
let cachedData = null;

window.onload = () => {
  ['cash-twd','settle-twd','cash-usd','loan-twd'].forEach(id => {
    const val = localStorage.getItem('wr_'+id.replace('-','_'));
    if(val) document.getElementById('inp-'+id).value = val;
  });
  refreshDashboard(true);
};

function switchView(v) {
  document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
  document.getElementById('view-' + v).classList.add('active');
  if(v !== 'input') {
      setTimeout(() => renderCharts(), 100);
  }
}

function refreshDashboard(isSilent) {
  const inputs = {
    cashTwd: document.getElementById('inp-cash-twd').value,
    settleTwd: document.getElementById('inp-settle-twd').value,
    cashUsd: document.getElementById('inp-cash-usd').value,
    loanTwd: document.getElementById('inp-loan-twd').value
  };
  scriptRun.withSuccessHandler(data => {
    cachedData = data;
    document.getElementById('loading-overlay-dash').style.display = 'none';
    document.getElementById('dashboard-content').style.display = 'block';
    document.getElementById('val-invest').innerText = data.investTotal.toLocaleString();
    document.getElementById('val-usdrate').innerText = data.usdRate.toFixed(2);
    document.getElementById('val-return').innerText = data.realizedReturn.toFixed(2) + '%';
    calcTotalNetWorth();
    renderCharts();
  }).getDashboardData(inputs);
}

function calcTotalNetWorth() {
  const t = Number(document.getElementById('inp-cash-twd').value || 0);
  const s = Number(document.getElementById('inp-settle-twd').value || 0);
  const u = Number(document.getElementById('inp-cash-usd').value || 0);
  const l = Number(document.getElementById('inp-loan-twd').value || 0);
  localStorage.setItem('wr_cash_twd', t); localStorage.setItem('wr_settle_twd', s); 
  localStorage.setItem('wr_cash_usd', u); localStorage.setItem('wr_loan_twd', l);
  const rate = cachedData ? cachedData.usdRate : 32.2;
  const total = (cachedData ? cachedData.investTotal : 0) + t + s + (u * rate) - l;
  document.getElementById('val-final-networth').innerText = Math.round(total).toLocaleString();
}

function renderCharts() {
  if(!cachedData) return;
  const config = (id, type, labels, data, isPie) => {
    const canvas = document.getElementById(id);
    if(!canvas) return;
    const ctx = canvas.getContext('2d');
    if(charts[id]) charts[id].destroy();
    
    charts[id] = new Chart(ctx, {
      type: type,
      data: { 
          labels, 
          datasets: [{ 
              label: 'åƒ¹å€¼',
              data, 
              backgroundColor: isPie ? ['#4285F4','#34A853','#FBBC05','#EA4335','#00BCD4','#8E24AA','#FF9800','#9E9E9E'] : 'rgba(47,123,255,0.2)', 
              borderColor: '#2f7bff', 
              fill: true,
              tension: 0.4,
              borderWidth: isPie ? 0 : 2
          }] 
      },
      options: { 
          responsive: true, 
          maintainAspectRatio: false, 
          plugins: { 
              legend: { 
                  display: isPie, 
                  position: 'right', 
                  labels:{ color:'#fff', boxWidth: 10, font: { size: 11 } } 
              }, 
              datalabels: { 
                  display: isPie, 
                  color: '#fff',
                  font: { weight: 'bold', size: 10 },
                  formatter: (v, c) => {
                      let sum = 0;
                      c.dataset.data.forEach(x => sum += x);
                      let perc = (v * 100 / sum).toFixed(1);
                      return perc > 3 ? perc + '%' : null; // ä½”æ¯”å¤§æ–¼ 3% æ‰é¡¯ç¤ºï¼Œé¿å…é‡ç–Š
                  }
              } 
          },
          scales: isPie ? {} : {
              x: { ticks: { color: '#a9b6d6', font: { size: 10 } } },
              y: { ticks: { color: '#a9b6d6' } }
          }
      }
    });
  };
  
  config('historyChart', 'line', cachedData.history.map(d=>d.date), cachedData.history.map(d=>d.val), false);
  config('assetsChart', 'doughnut', cachedData.assets.map(d=>d.name), cachedData.assets.map(d=>d.value), true);
  config('regionsChart', 'doughnut', cachedData.regions.map(d=>d.name), cachedData.regions.map(d=>d.value), true);
}

function quick(n,s,p){ document.getElementById('name').value=n; document.getElementById('symbol').value=s; document.getElementById('platform').value=p; }

function submitTrade() {
  const btn = document.querySelector('button.primary');
  // â˜… ç§»é™¤å¼·åˆ¶æª¢æŸ¥é‚è¼¯ï¼Œç¾åœ¨åç¨±å¯ä»¥ç•™ç©º
  const nameInput = document.getElementById('name');
  const name = nameInput.value.trim(); 

  btn.disabled = true;
  const payload = {
    defaults: { platform: document.getElementById('platform').value, account: document.getElementById('account').value },
    trades: [{
      type: document.getElementById('type').value, name: name, symbol: document.getElementById('symbol').value,
      price: Number(document.getElementById('price').value), qty: Number(document.getElementById('qty').value),
      fee: Number(document.getElementById('fee').value), tax: Number(document.getElementById('tax').value),
      cost: Number(document.getElementById('cost').value), date: new Date().toLocaleDateString('zh-TW')
    }]
  };
  scriptRun.withSuccessHandler(res => {
    btn.disabled = false;
    const msgEl = document.getElementById('msg');
    msgEl.innerText = "âœ… æˆåŠŸå¯«å…¥ç¬¬ " + res.row + " åˆ—";
    msgEl.className = "toast info";
    msgEl.style.display = "block";
    setTimeout(() => { msgEl.style.display = "none"; msgEl.className = "toast"; }, 3000);
  }).saveTrades(payload);
}

function toggleAI() { const win = document.getElementById('ai-window'); win.style.display = win.style.display === 'flex' ? 'none' : 'flex'; }
function sendChat() {
  const input = document.getElementById('ai-input');
  const text = input.value.trim(); if(!text) return;
  appendMsg(text, 'user'); input.value = '';
  appendMsg('å’ªå’ªæ€è€ƒä¸­...', 'mimi', 'loading-ai');
  scriptRun.withSuccessHandler(res => {
    document.getElementById('loading-ai').innerText = res;
    document.getElementById('loading-ai').id = '';
  }).callGeminiAnalysis(text, cachedData);
}
function appendMsg(t, type, id) {
  const body = document.getElementById('ai-chat-body');
  const div = document.createElement('div'); div.className = 'msg msg-' + type; div.innerText = t; if(id) div.id = id;
  body.appendChild(div); body.scrollTop = body.scrollHeight;
}
</script>
</body>
</html>